{% extends 'core/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        
        <div class="mb-4">
            <form class="d-flex shadow-sm rounded-pill bg-white p-1 border" style="border-color: #ddd6fe !important;" method="GET" action="{% url 'feed' %}">
                <input class="form-control border-0 rounded-pill ps-3" type="search" name="q" placeholder="Search pets..." value="{{ search_query|default:'' }}">
                <button class="btn btn-purple rounded-pill px-4" type="submit">Search</button>
            </form>
        </div>

        <div class="card shadow-sm mb-4 border-0">
            <div class="card-body">
                <h5 class="fw-bold mb-3" style="color: #4c1d95;">Share an Update</h5>
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <textarea name="caption" class="form-control mb-3" placeholder="What's your pet doing?" rows="2" required></textarea>
                    <div class="d-flex justify-content-between align-items-center">
                        <input type="file" name="image" class="form-control form-control-sm w-auto" accept="image/*" required>
                        <button type="submit" class="btn btn-purple px-4">Post</button>
                    </div>
                </form>
            </div>
        </div>

        <h3 class="fw-bold mb-4" style="color: #4c1d95;">Community Feed</h3>

        {% for post in posts %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <span class="fw-bold">@{{ post.author.username }}</span>
            </div>

            {% if post.image %}
                <img src="{{ post.image.url }}" class="card-img-top" style="max-height: 500px; object-fit: cover;">
            {% endif %}

            <div class="card-body">
                <button class="btn btn-link text-danger p-0 text-decoration-none like-btn" data-id="{{ post.id }}">
                    <i class="{% if request.user in post.likes.all %}fa-solid{% else %}fa-regular{% endif %} fa-heart"></i> 
                    <span class="like-count">{{ post.likes.count }}</span>
                </button>

                <p class="mt-2 mb-1"><strong>{{ post.author.username }}</strong> {{ post.caption }}</p>

                <div class="mt-3 border-top pt-2">
                    {% for comment in post.comments.all %}
                        <p class="small mb-1"><strong>{{ comment.user.username }}</strong> {{ comment.text }}</p>
                    {% endfor %}
                    
                    <form action="{% url 'add_comment' post.id %}" method="POST" class="mt-2">
                        {% csrf_token %}
                        <div class="input-group input-group-sm">
                            <input type="text" name="text" class="form-control" placeholder="Comment..." required>
                            <button class="btn btn-purple" type="submit">Send</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.querySelectorAll('.like-btn').forEach(button => {
    button.onclick = function(e) {
        e.preventDefault();
        const postId = this.getAttribute('data-id');
        const icon = this.querySelector('i');
        const countSpan = this.querySelector('.like-count');

        fetch(`/like/${postId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.liked) {
                icon.classList.replace('fa-regular', 'fa-solid');
            } else {
                icon.classList.replace('fa-solid', 'fa-regular');
            }
            countSpan.innerText = data.count;
        });
    };
});
</script>
{% endblock %}